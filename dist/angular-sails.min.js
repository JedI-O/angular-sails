/*!
 * angular-sails
 * An angular provider for using the sails socket.io api
 * @version v1.1.0
 * @link https://github.com/kyjan/angular-sails
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(e,t,n){"use strict";function o(e){var n,o,i,s={};return e?(t.forEach(e.split("\n"),function(e){i=e.indexOf(":"),n=t.lowercase(r(e.substr(0,i))),o=r(e.substr(i+1)),n&&(s[n]=s[n]?s[n]+", "+o:o)}),s):s}function r(e){return t.isString(e)?e.trim():e}function i(e){return e&&t.isFunction(e.then)}function s(e){var r=t.isObject(e)?e:n;return function(n){if(r||(r=o(e)),n){var i=r[t.lowercase(n)];return void 0===i&&(i=null),i}return r}}function a(e,n){if(!t.isArray(e))throw new TypeError('Expected type "array" by got type "'+Object.prototype.toString.call(e)+'".');if(Array.prototype.indexOf)return e.indexOf(n);var o=0,r=e.length;if(0===r)return-1;for(;r>o;){if(o in e&&e[o]===n)return o;o++}return-1}function c(e,n){if(!n)return e;var o=[];return u(n,function(e,n){null===e||t.isUndefined(e)||(t.isArray(e)||(e=[e]),t.forEach(e,function(e){t.isObject(e)&&(e=t.isDate(e)?e.toISOString():t.toJson(e)),o.push(f(n)+"="+f(e))}))}),o.length>0&&(e+=(-1==e.indexOf("?")?"?":"&")+o.join("&")),e}function u(e,t,n){for(var o=d(e),r=0;r<o.length;r++)t.call(n,e[o[r]],o[r]);return o}function d(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t.sort()}function f(e,t){return encodeURIComponent(e).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,t?"%20":"+")}function l(e,n){var o=this,r=["post","put","patch"];o.httpVerbs=n.httpVerbs=["get","post","put","patch","delete","head"],o.eventNames=n.eventNames=["on","off","once"],o.config={transports:["websocket","polling"]},o.debug=e.debug=n.debug=!1,o["debugger"]=function(t){o.debug=e.debug=n.debug=t},o.defaults={transformResponse:[],transformRequest:[],headers:{}},o.interceptors=e.interceptors=[],this.$get=["$q","$log","$timeout","$sailsIo","$sailsInterceptor",function(e,n,i,c,u){function d(e){return d[e.method](e.url,e)}function f(e){d[e]=h[e].bind(h)}function l(e){d[e]=function(n,i,c){var d={method:e,transformRequest:o.defaults.transformRequest,transformResponse:o.defaults.transformResponse,headers:{}};c=c||{},-1===a(r,e)?(c=i||c,delete c.data):c.data=i,t.extend(d,c),d.url=(o.urlPrefix||"")+(n||d.url),d.method=(d.method||e).toUpperCase();var f=u(h[e].bind(h),d);return f.success=function(e){return f.then(function(t){e(t.data,t.status,s(t.headers),t.config)}),f},f.error=function(e){return f.then(null,function(t){e(t.data,t.status,s(t.headers),t.config)}),f},f}}function p(e){d[e]=h[e].bind(h)}var h=new c(o.socket||o.url,o.config),g=["connect","disconnect","isConnected"];return d._socket=h,t.forEach(o.httpVerbs,l,this),t.forEach(o.eventNames,p,this),t.forEach(g,f,this),d.$modelUpdater=function(e,r){h.on(e,function(i){var s;switch(o.debug&&n.info("$sails "+e+" model "+i.verb+" id: "+i.id,i.data),i.verb){case"created":r.push(i.data);break;case"updated":var a;for(s=0;s<r.length;s++)if(r[s].id===i.id){a=r[s];break}if(!a&&!i.previous)return;a||(a=i.previous,r.push(a)),t.extend(a,i.data);break;case"destroyed":for(s=0;s<r.length;s++)if(r[s].id===i.id){r.splice(s,1);break}}})},d.defaults=this.defaults,d}]}function p(){var e=this;e.interceptors=[],this.$get=["$injector","$q",function(o,r){function a(e){return t.extend({},e,{data:u(e.data,s(e.headers),e.transformRequest||[])})}function c(e){var n=t.extend({},e,{data:u(e.data,e.headers,e.config&&e.config.transformResponse||[])});return 200<=e.status&&e.status<300?n:r.reject(n)}function u(e,n,o){return t.isFunction(o)?o(e,n):(t.forEach(o,function(t){e=t(e,n)}),e)}var d=[];t.forEach(e.interceptors,function(e){d.unshift(t.isString(e)?o.get(e):o.invoke(e))});var f=function(e,o){var s=e;i(e)&&(s=function(){return e});var u=[a,n,s,n,c,c],f=r.when(o);for(t.forEach(d,function(e){(e.request||e.requestError)&&u.unshift(e.request,e.requestError),(e.response||e.responseError)&&u.push(e.response,e.responseError)});u.length;){var l=u.shift(),p=u.shift();f=f.then(l,p)}return f};return f}]}function h(){var e=this;e.httpVerbs=["get","post","put","delete"],e.eventNames=["on","off","once"],this.$get=["$rootScope","$q","$log","socketIo","sailsSdk",function(n,o,r,i,s){function a(e,t){return this.connect(e,t)}var u=i;return a.prototype.connect=function(n,i){var a=this;if(i=i||{},a._socket&&a._socket.connected)throw new Error("Socket is already connected.");return a.connectDefer||(a.connectDefer=o.defer()),t.isObject(n)&&t.isFunction(n.on)&&t.isFunction(n.emit)?(a._socket=n,a.connectDefer.resolve()):(t.isString(i.query)?i.query+="&"+s.versionString():i.query=s.versionString(),a._socket&&a._socket.connected||(a._socket=u(i.url,i),a.connectDefer.resolve())),e.debug&&(a.on("connect",r.info.bind(a,"$sails connected.")),a.on("disconnect",r.info.bind(a,"$sails disconnected.")),a.on("reconnecting",function(e){r.warn.bind(a,"$sails is attemping to reconnect. (#"+e+")")}),a.on("reconnect",function(e,t){r.info.bind(a,"$sails successfully reconnected after "+t+" attemps.")}),a.on("error",function(e){r.error("$sails could not connect:",e)})),a},a.prototype.disconnect=function(){var e=this;e._socket&&e._socket.disconnect(),e.connectDefer&&e.connectDefer.reject("disconnect"),e.connectDefer=o.defer()},a.prototype.isConnected=function(){return this._socket?this._socket.connected:!1},a.prototype._send=function(t,n){var o=this,i=t.method.toLowerCase();o.connectDefer.promise.then(function(){e.debug&&r.info("$sails "+t.method+" "+t.url,t.data||""),o._socket.emit(i,t,function(o){e.debug&&r.info("$sails"+t.method+" "+t.url+" response received",o);var i={data:o.body||o||{},status:o.statusCode||o.status||o.Status||200,headers:o.headers||{},config:t};i.statusText=v[i.status],200<=i.status&&i.status<300?n.reject(i):n.resolve(i)})},function(){e.debug&&r.warn("$sails"+t.method+" "+t.url+" request terminated",t),n.reject({data:null,status:0,headers:{},config:t,statusText:null})})},a.prototype._req=function(e){var t=this,n=o.defer();if(e.url=c(e.url.replace(/^(.+)\/*\s*$/,"$1"),e.params),e.headers=e.headers||{},e.data=e.data||{},e.method=e.method.toUpperCase(),"string"!=typeof e.url)throw new Error("Invalid or missing URL!");return t._send(e,n),n.promise},t.forEach(e.httpVerbs,function(e){a.prototype[e]=a.prototype._req}),t.forEach(e.eventNames,function(e){a.prototype[e]=function(o,r){var i=this;null!==r&&t.isFunction(r)&&i._socket[e](o,function(e){n.$evalAsync(r.bind(i,e))})}},this),a}]}function g(e){if(!e.io)throw new Error("Socket.io-client not found. Ensure socket.io-client is loaded before this script");return e.io}t.module("ngSails",["ngSails.$sails"]);var v={100:"100 Continue",101:"101 Switching Protocols",102:"102 Processing",200:"200 OK",201:"201 Created",202:"202 Accepted",203:"203 Non-Authoritative Information",204:"204 No Content",205:"205 Reset Content",206:"206 Partial Content",207:"207 Multi-Status",208:"208 Already Reported",226:"226 IM Used",300:"300 Multiple Choices",301:"301 Moved Permanently",302:"302 Found",303:"303 See Other",304:"304 Not Modified",305:"305 Use Proxy",306:"306 (Unused)",307:"307 Temporary Redirect",308:"308 Permanent Redirect",400:"400 Bad Request",401:"401 Unauthorized",402:"402 Payment Required",403:"403 Forbidden",404:"404 Not Found",405:"405 Method Not Allowed",406:"406 Not Acceptable",407:"407 Proxy Authentication Required",408:"408 Request Timeout",409:"409 Conflict",410:"410 Gone",411:"411 Length Required",412:"412 Precondition Failed",413:"413 Payload Too Large",414:"414 URI Too Long",415:"415 Unsupported Media Type",416:"416 Range Not Satisfiable",417:"417 Expectation Failed",422:"422 Unprocessable Entity",423:"423 Locked",424:"424 Failed Dependency",426:"426 Upgrade Required",428:"428 Precondition Required",429:"429 Too Many Requests",431:"431 Request Header Fields Too Large",500:"500 Internal Server Error",501:"501 Not Implemented",502:"502 Bad Gateway",503:"503 Service Unavailable",504:"504 Gateway Timeout",505:"505 HTTP Version Not Supported",506:"506 Variant Also Negotiates",507:"507 Insufficient Storage",508:"508 Loop Detected",510:"510 Not Extended",511:"511 Network Authentication Required"};t.module("ngSails.$sails",["ngSails.$sailsIo","ngSails.$sailsInterceptor"]).provider("$sails",l),l.$inject=["$sailsInterceptorProvider","$sailsIoProvider"],t.module("ngSails.$sailsInterceptor",[]).provider("$sailsInterceptor",p),t.module("ngSails.$sailsIo",["ngSails.sailsSdk","ngSails.socketIo"]).provider("$sailsIo",h),t.module("ngSails.sailsSdk",[]).constant("sailsSdk",{info:{version:{key:"__sails_io_sdk_version",value:"0.11.0"},platform:{key:"__sails_io_sdk_platform",value:"undefined"==typeof module?"browser":"node"},language:{key:"__sails_io_sdk_language",value:"javascript"}},versionString:function(){var e=this;return function(){var n=[];return t.forEach(e.info,function(e){n.push(e.key+"="+e.value)}),n.join("&")}()}}),t.module("ngSails.socketIo",[]).factory("socketIo",g),g.$inject=["$window"]}(window,window.angular);